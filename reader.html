<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reader — Classy Femininity</title>
  <style>
    /* …your existing CSS for loader, paywall, nav… */
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
</head>
<body>
  <div id="loader"><div class="spinner"></div></div>
  <div id="paywall">
    <p>Free preview (5 pages).<br/>Subscribe to continue.</p>
    <button id="monthly-btn">Subscribe Monthly</button>
    <button id="yearly-btn">Subscribe Yearly</button>
  </div>
  <canvas id="canvas"></canvas>
  <div class="nav">
    <button id="prev">◀ Prev</button>
    <span id="page-num">1</span> / <span id="page-count">?</span>
    <button id="next">Next ▶</button>
  </div>

  <script>
  window.addEventListener('load', () => {
    // ——— PADDLE Initialization ———
    const PADDLE_VENDOR_ID    = 31791;               // ← your Seller ID
    const PADDLE_CLIENT_TOKEN = 'test_c1d926aee93e8ff9dbd35392581';   // ← your client-side token
    const PADDLE_MONTHLY_ID   = 'pri_01jvthzpme46yzb6g6b7er4jnk';
    const PADDLE_YEARLY_ID    = 'pri_01jvtj0dch0kb39g9rej1qexyg';

    Paddle.Environment.set('sandbox'); // or 'production'
    Paddle.Initialize({
      vendor: PADDLE_VENDOR_ID,
      token:  PADDLE_CLIENT_TOKEN
    });

    function onSubscribed() {
      localStorage.setItem('subscribed','true');
      document.getElementById('paywall').style.display = 'none';
      queueRenderPage(pageNum);
    }

    document.getElementById('monthly-btn').onclick = () =>
      Paddle.Checkout.open({ product: PADDLE_MONTHLY_ID, successCallback: onSubscribed });

    document.getElementById('yearly-btn').onclick = () =>
      Paddle.Checkout.open({ product: PADDLE_YEARLY_ID,  successCallback: onSubscribed });
    // ————————————————————————————

    // ——— PDF.js + paywall logic ———
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const params = new URLSearchParams(location.search),
          bookId = params.get('book') || '1',
          pdfUrl = `/ebooks/book-${bookId}.pdf`;

    const loader  = document.getElementById('loader'),
          paywall = document.getElementById('paywall');

    function showLoader(on) { loader.style.display = on ? 'flex' : 'none'; }

    fetch(pdfUrl, { method:'HEAD' })
      .then(r => { if(!r.ok) throw new Error(r.status); return pdfjsLib.getDocument(pdfUrl).promise; })
      .then(pdf => {
        document.getElementById('page-count').textContent = pdf.numPages;
        showLoader(false);
        initializeViewer(pdf);
      })
      .catch(err => {
        console.error(err);
        showLoader(false);
        document.body.innerHTML = `<p class="error">Could not load PDF: ${err.message}</p>`;
      });

    let pageNum=1, pageIsRendering=false, pageNumPending=null;
    function initializeViewer(pdfDoc) {
      const canvasEl = document.getElementById('canvas'),
            ctx      = canvasEl.getContext('2d');

      function renderPage(n) {
        if(n>5 && localStorage.getItem('subscribed')!=='true'){
          paywall.style.display='flex';
          return;
        }
        paywall.style.display='none';
        pageIsRendering=true;
        pdfDoc.getPage(n).then(page => {
          const vp = page.getViewport({ scale:1.5 });
          canvasEl.height=vp.height; canvasEl.width=vp.width;
          page.render({ canvasContext:ctx, viewport:vp }).promise.then(()=>{
            pageIsRendering=false;
            if(pageNumPending!==null){ renderPage(pageNumPending); pageNumPending=null; }
          });
          document.getElementById('page-num').textContent=n;
        });
      }
      function queueRenderPage(n){
        pageIsRendering? pageNumPending=n : renderPage(n);
      }
      document.getElementById('prev').onclick = () => {
        if(pageNum>1){ pageNum--; queueRenderPage(pageNum); }
      };
      document.getElementById('next').onclick = () => {
        if(pageNum < pdfDoc.numPages){ pageNum++; queueRenderPage(pageNum); }
      };
      renderPage(pageNum);
    }
    // ——————————————————————
  });
  </script>
</body>
</html>
