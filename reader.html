<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reader — Classy Femininity</title>
  <style>
    /* (Your existing CSS: loader, paywall, nav, etc.) */
  </style>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- Lemon Squeezy overlay JS (no server needed!) -->
  <script src="https://app.lemonsqueezy.com/js/lemon.js" defer></script>
</head>
<body>
  <!-- Loader -->
  <div id="loader"><div class="spinner"></div></div>

  <!-- Paywall -->
  <div id="paywall">
    <p>You’ve reached your free preview (5 pages). Subscribe to continue reading.</p>
    <!-- Simply link to your hosted checkout URLs -->
    <a
      href="https://YOUR-STORE.lemonsqueezy.com/checkout/buy/816280"
      class="lemonsqueezy-button"
      id="monthly-btn"
    >
      Subscribe Monthly
    </a>
    <a
      href="https://YOUR-STORE.lemonsqueezy.com/checkout/buy/816279"
      class="lemonsqueezy-button"
      id="yearly-btn"
    >
      Subscribe Yearly
    </a>
  </div>

  <!-- PDF canvas + nav (unchanged) -->
  <canvas id="canvas"></canvas>
  <div class="nav">…</div>

  <script>
  window.addEventListener('load', () => {
    // 1) If ?subscribed=1 is in URL, mark them unlocked
    const params = new URLSearchParams(location.search);
    if (params.get('subscribed') === '1') {
      localStorage.setItem('subscribed','true');
      history.replaceState(null,'',`reader.html?book=${params.get('book')||1}`);
    }

    // 2) Listen for Lemon Squeezy overlay success event
    window.addEventListener('Checkout.Success', () => {
      localStorage.setItem('subscribed','true');
      document.getElementById('paywall').style.display = 'none';
      queueRenderPage(pageNum);
    });

    // 3) PDF.js + paywall gating (your existing code)
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const bookId = params.get('book') || '1';
    const pdfUrl = `/ebooks/book-${bookId}.pdf`;
    const loader = document.getElementById('loader'),
          paywall = document.getElementById('paywall'),
          canvas = document.getElementById('canvas'),
          ctx = canvas.getContext('2d'),
          prev = document.getElementById('prev'),
          next = document.getElementById('next'),
          pageNumEl = document.getElementById('page-num'),
          pageCountEl = document.getElementById('page-count');

    function showLoader(on){ loader.style.display = on?'flex':'none'; }

    fetch(pdfUrl, { method:'HEAD' })
      .then(r => { if(!r.ok) throw new Error(r.status); return pdfjsLib.getDocument(pdfUrl).promise; })
      .then(pdf => {
        pageCountEl.textContent = pdf.numPages;
        showLoader(false);
        initializeViewer(pdf);
      })
      .catch(e => {
        console.error(e);
        document.body.innerHTML = `<p class="error">Could not load PDF: ${e.message}</p>`;
      });

    let pageNum=1, rendering=false, pending=null;
    function initializeViewer(pdf) {
      function render(num) {
        if(num>5 && localStorage.getItem('subscribed')!=='true') {
          paywall.style.display='flex';
          return;
        }
        paywall.style.display='none';
        rendering=true;
        pdf.getPage(num).then(page => {
          const vp = page.getViewport({ scale:1.5 });
          canvas.width=vp.width; canvas.height=vp.height;
          page.render({ canvasContext:ctx, viewport:vp }).promise.then(() => {
            rendering=false;
            if(pending!==null) { render(pending); pending=null; }
          });
          pageNumEl.textContent=num;
        });
      }
      function queue(num){ rendering? pending=num : render(num); }
      prev.onclick=()=>{ if(pageNum>1){ pageNum--; queue(pageNum); }};
      next.onclick=()=>{ if(pageNum<parseInt(pageCountEl.textContent)){ pageNum++; queue(pageNum); }};
      render(pageNum);
    }
  });
  </script>
</body>
</html>
